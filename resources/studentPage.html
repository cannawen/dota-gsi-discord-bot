<html>
    <head>
        <title>Private Coaching</title>
        <script>
            function fetchAndPlay() {
                return fetch("./poll")
                    .then((res) => res.json())
                    .then((res) => {
                        return new Promise((resolve) => {
                            if (res.nextAudio) {
                                const f = new Audio("/" + res.nextAudio);
                                f.addEventListener("ended", resolve);
                                f.play();
                            } else if (res.configUpdated) {
                                getConfig();
                                resolve();
                            } else {
                                resolve();
                            }
                        });
                    });
            }

            function loop() {
                try {
                    fetchAndPlay().then(() => setTimeout(loop, 500));
                } catch (error) {
                    loop();
                }
            }

            function stopAudio() {
                fetch("./stop-audio");
            }

            function startCoaching(e) {
                e.target.remove();
                document.getElementById("coaching").style.display = "block";
                loop();
            }

            function makePublic(e) {
                const rule = e.target.id;
                fetch(`./config/${rule}/PUBLIC`, { method: "POST" });
            }

            function makePrivate(e) {
                const rule = e.target.id;
                fetch(`./config/${rule}/PRIVATE`, { method: "POST" });
            }

            function disable(e) {
                const rule = e.target.id;
                fetch(`./config/${rule}/NONE`, { method: "POST" });
            }

            function getConfig() {
                fetch("./config")
                    .then((res) => res.json())
                    .then((res) => {
                        const message = res.reduce((memo, configInput) => {
                            const configString = JSON.stringify(configInput);
                            return (
                                memo +
                                `<div>
                                    <button id="${configInput[0]}" onClick="makePublic(event)">Make public</button>
                                    <button id="${configInput[0]}" onClick="makePrivate(event)">Make private</button>
                                    <button id="${configInput[0]}" onClick="disable(event)">Disable</button>
                                    ${configString}
                                </div>`
                            );
                        }, "<div>Your coaching preferences:</div><br/>");
                        const explanation = [
                            "PRIVATE means playing only on this site",
                            "PUBLIC or PUBLIC_INTERRUPTING means playing on discord",
                            "null or NONE means this rule is disabled</div>",
                            "<br/>",
                            "If you are seeing null, perhaps you have not started /coachme or perhaps a different user is already playing public audio on the same voice channel",
                        ].reduce((memo, text) => {
                            return memo + `<div>${text}</div>`;
                        }, "");
                        document.getElementById("config").innerHTML =
                            message + "<br/>" + explanation;
                    });
            }
        </script>
    </head>
    <body onload="getConfig()">
        <button onClick="stopAudio()">Stop all audio</button>
        <button onClick="startCoaching(event)">START COACHING</button>
        <div style="background-color: green; display: none" id="coaching">
            Coaching...
        </div>
        <div id="config"></div>
    </body>
</html>
