<html>
    <head>
        <title>Private Coaching</title>
        <script>
            function fetchAndPlay() {
                return fetch("./poll")
                    .then((res) => res.json())
                    .then((res) => {
                        return new Promise((resolve) => {
                            if (res.nextAudio) {
                                const f = new Audio("/" + res.nextAudio);
                                f.addEventListener("ended", resolve);
                                f.play();
                            } else if (res.configUpdated) {
                                getConfig();
                                resolve();
                            } else {
                                resolve();
                            }
                        });
                    });
            }

            function loop() {
                try {
                    fetchAndPlay().then(() => setTimeout(loop, 500));
                } catch (error) {
                    loop();
                }
            }

            function startCoaching(e) {
                e.target.remove();
                document.getElementById("coaching").style.display = "block";
                loop();
            }

            function makePublic(e) {
                const rule = e.target.id;
                fetch(`./config/${rule}/PUBLIC`, { method: "POST" });
            }

            function makePrivate(e) {
                const rule = e.target.id;
                fetch(`./config/${rule}/PRIVATE`, { method: "POST" });
            }

            function disable(e) {
                const rule = e.target.id;
                fetch(`./config/${rule}/NONE`, { method: "POST" });
            }

            function onLoad() {
                getConfig();
                getDiscordEnabled();
            }

            function getDiscordEnabled() {
                fetch("./discordAudioEnabled")
                    .then((res) => res.json())
                    .then((res) => {
                        if (res === false) {
                            document.getElementById("warning").style.display =
                                "block";
                        }
                    });
            }

            function getConfig() {
                fetch("./config")
                    .then((res) => res.json())
                    .then((res) => {
                        const message = res.reduce((memo, configInput) => {
                            const configString = JSON.stringify(configInput);
                            return (
                                memo +
                                `<div>
                                    <button id="${configInput[0]}" onClick="makePublic(event)">Make public</button>
                                    <button id="${configInput[0]}" onClick="makePrivate(event)">Make private</button>
                                    <button id="${configInput[0]}" onClick="disable(event)">Disable</button>
                                    ${configString}
                                </div>`
                            );
                        }, "<div>Your coaching preferences:</div><br/>");
                        const explanation = [
                            "PRIVATE means playing only on this site",
                            "PUBLIC or PUBLIC_INTERRUPTING means playing on discord",
                            "NONE means this rule is disabled</div>",
                            "<br/>",
                            "If you are not seeing any preferences, perhaps you have not started /coachme",
                        ].reduce((memo, text) => {
                            return memo + `<div>${text}</div>`;
                        }, "");
                        document.getElementById("config").innerHTML =
                            message + "<br/>" + explanation;
                    });
            }

            function stopAudio() {
                fetch("./stop-audio", { method: "POST" });
            }

            function resetConfig() {
                fetch("./reset-config", { method: "POST" });
            }

            function saveState() {
                fetch("/saveState", { method: "POST" });
            }

            function readState() {
                fetch("/readState", { method: "POST" });
            }

            function kill() {
                fetch("/kill", { method: "POST" });
            }
        </script>
    </head>
    <body onload="onLoad()">
        <div id="warning" style="display: none">
            <div style="font-size: 3em; background-color: red">
                PUBLIC AUDIO DISABLED
            </div>
            <div>
                Is there another student in the channel you are in? Your private
                audio will still work, but your public audio is disabled. You
                will still hear the first student's public audio based on their
                configuration settings.
            </div>
            <br />
            <br />
        </div>
        <button
            onClick="startCoaching(event)"
            style="font-size: 5em; cursor: pointer"
        >
            START COACHING
        </button>
        <div
            style="background-color: green; display: none; font-size: 5em"
            id="coaching"
        >
            Coaching...
        </div>
        <br />
        <br />
        <div id="config"></div>
        <br />
        <button onClick="resetConfig()">Reset to default config</button>
        <button onClick="stopAudio()">Stop all audio</button>
        <br />
        <div style="display: none">
            <button onClick="saveState()">save state</button>
            <button onClick="readState()">read state</button>
            <button onClick="kill()">kill</button>
        </div>
    </body>
</html>
